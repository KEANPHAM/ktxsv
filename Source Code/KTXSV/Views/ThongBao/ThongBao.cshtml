@model IEnumerable<KTXSV.Models.Notification>

@{
    ViewBag.Title = "Thông báo của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --custom-primary: #EE6823;
        --custom-unread-bg: #fff9f5;
    }

    .bg-custom-primary {
        background-color: var(--custom-primary) !important;
    }

    .text-custom-primary {
        color: var(--custom-primary) !important;
    }

    .border-custom-primary {
        border-color: var(--custom-primary) !important;
    }

    .badge.bg-custom-primary {
        background-color: var(--custom-primary) !important;
        color: white; 
    }

    .notification-item, .unread-notification-item {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 0.5rem; 
    }

        .notification-item:hover, .unread-notification-item:hover {
            transform: translateY(-2px); 
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1) !important; 
        }

    .unread-notification-item {
        background-color: var(--custom-unread-bg) !important; 
        border-left: 5px solid var(--custom-primary); 
    }


    .notification-item {
        border: 1px solid #f0f0f0;
    }

    .modal-header.bg-custom-primary {
        border-bottom: none;
    }

    .notification-content-body {
        font-size: 1rem;
        line-height: 1.6;
        color: #333;
    }
</style>

<div class="container mt-5">

    @if (!Model.Any())
    {
        <div class="alert alert-info shadow-sm p-4 text-center" role="alert">
            <i class="bi bi-info-circle-fill me-2"></i> Hiện tại bạn chưa có thông báo nào.
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-10">
                @foreach (var n in Model.OrderByDescending(x => x.CreatedAt))
                {
                    var isUnread = !n.IsRead;
                    var itemClass = isUnread ? "card mb-3 shadow-sm unread-notification-item" : "card mb-3 shadow-sm notification-item";

                    <div class="@itemClass" style="cursor:pointer;"
                         data-bs-toggle="modal" data-bs-target="#modal-@n.NotiID"
                         data-notification-id="@n.NotiID">
                        <div class="card-body p-3">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h5 class="card-title mb-1 @(isUnread ? "text-custom-primary fw-bold" : "text-dark")">
                                        @if (isUnread)
                                        {
                                            <span class="badge bg-custom-primary me-2">Mới</span>
                                        }
                                        @n.Title
                                    </h5>
                                    <small class="text-muted d-block mb-2">
                                        <i class="bi bi-clock me-1"></i> @(n.CreatedAt.HasValue ? n.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm") : "")
                                    </small>
                                </div>
                                <a href="javascript:void(0);" class="text-decoration-none ms-3" style="color:var(--custom-primary);"
                                   data-bs-toggle="modal" data-bs-target="#modal-@n.NotiID">
                                    Xem chi tiết <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="modal-@n.NotiID" tabindex="-1" aria-labelledby="modalLabel-@n.NotiID" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content shadow-lg border-0">
                                <div class="modal-header bg-custom-primary text-white">
                                    <h5 class="modal-title" id="modalLabel-@n.NotiID">@n.Title</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4 notification-content-body">
                                    @Html.Raw(n.Content)
                                </div>
                                <div class="modal-footer d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Thời gian: @(n.CreatedAt.HasValue ? n.CreatedAt.Value.ToString("dd/MM/yyyy HH:mm") : "")
                                    </small>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var modals = document.querySelectorAll(".modal");
            modals.forEach(function (modalEl) {
                modalEl.addEventListener('show.bs.modal', function () {
                    var notiId = modalEl.id.split('-')[1];
                    // Tìm thẻ  cha 
                    var parentItem = document.querySelector(`[data-notification-id="${notiId}"]`);

                    //   đánh dấu đã đọc 
                    fetch('/ThongBao/MarkAsRead/' + notiId, { method: 'POST' });

                    //  Cập nhật giao diện item đã đọc ngay lập tức
                    if (parentItem && parentItem.classList.contains('unread-notification-item')) {
                        parentItem.classList.remove('unread-notification-item');
                        parentItem.classList.add('notification-item'); 

                        var titleElement = parentItem.querySelector('h5');
                        if (titleElement) {
                            titleElement.classList.remove('text-custom-primary', 'fw-bold');
                            titleElement.classList.add('text-dark');
                            // Xóa tag 'Mới'
                            var badgeElement = titleElement.querySelector('.badge');
                            if (badgeElement) badgeElement.remove();
                        }

                        var detailLink = parentItem.querySelector('.text-decoration-none');
                        if (detailLink) {
                            detailLink.style.color = 'var(--custom-primary)';
                        }
                    }
                });
            });
        });
    </script>
}