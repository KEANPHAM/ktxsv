@model KTXSV.Models.Payment

@{
    ViewBag.Title = "Tạo hóa đơn";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header text-white" style="background-color:#EE6823;">
            <h5 class="mb-0">Tạo hóa đơn mới</h5>
        </div>

        <div class="card-body">

            @using (Html.BeginForm("Create", "PaymentAdmin", FormMethod.Post))
            {
                @Html.AntiForgeryToken()

                <div class="row g-3">

                    <!-- Chọn sinh viên -->
                    <div class="col-md-6">
                        <label class="form-label">Sinh viên - Phòng</label>
                        @Html.DropDownListFor(m => m.RegID,
                            (IEnumerable<SelectListItem>)ViewBag.RegistrationsDisplay,
                            "Chọn sinh viên ",
                            new { @class = "form-select", id = "RegID" })
                    </div>

                    <!-- Số tiền -->
                    <div class="col-md-6">
                        <label class="form-label">Số tiền (VNĐ)</label>

                        <!-- Ô nhập tiền (không readonly nữa) -->
                        @Html.TextBoxFor(m => m.Amount, new
                        {
                            @class = "form-control",
                            id = "Amount",
                            placeholder = "Nhập giá"
                        })
                    </div>

                    <!-- 2 loại thanh toán -->
                    <div class="col-md-6">
                        <label class="form-label">Loại thanh toán</label>
                        @Html.DropDownListFor(m => m.Type,
                            new List<SelectListItem>
                            {
                                new SelectListItem { Value = "Rent", Text = "Tiền nhà" },
                                new SelectListItem { Value = "Other", Text = "Khác" }
                            },
                            new { @class = "form-select" })
                    </div>

                    <!-- Ngày -->
                    <div class="col-md-6">
                        <label class="form-label">Ngày tạo hóa đơn</label>
                        @Html.TextBoxFor(m => m.PaymentDate, "{0:yyyy-MM-dd}",
                            new { type = "date", @class = "form-control" })
                    </div>

                    <!-- Trạng thái -->
                    <div class="col-md-6">
                        <label class="form-label">Trạng thái</label>
                        <input type="text" class="form-control" value="Chưa thanh toán" readonly />
                        @Html.HiddenFor(m => m.Status, new { value = "Unpaid" })
                    </div>

                    <div class="col-12 text-end">
                        <button class="btn text-white" style="background-color:#EE6823;">Lưu</button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary ms-2">Hủy</a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section scripts{
    <script>
        const reg = document.getElementById("RegID");
        const amount = document.getElementById("Amount");

        function loadAmount(regId) {
            if (!regId) return;

            fetch(`/PaymentAdmin/GetAmountByRegistration?regId=${regId}`)
                .then(r => r.json())
                .then(data => {
                    // nhận bất kỳ dạng trả về
                    const money = data.amount || data.Amount;

                    if (money) {
                        amount.value = money;
                    } else {
                        // không có tiền → cho user tự nhập
                        amount.value = "";
                    }
                })
                .catch(() => {
                    amount.value = "";
                });
        }

        reg.addEventListener("change", () => loadAmount(reg.value));

        // auto chạy khi load page
        if (reg.value) loadAmount(reg.value);
    </script>
}
