﻿@model IEnumerable<KTXSV.Models.Payment>

@{
    ViewBag.Title = "HoaDon";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h2>Hóa đơn của tôi</h2>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <table class="table table-bordered table-striped mt-3">
        <thead class="table-dark">
            <tr>
                <th>Mã HĐ</th>
                <th>Loại</th>
                <th>Số tiền</th>
                <th>Ngày tạo</th>
                <th>Trạng thái</th>
                <th>Thanh Toán</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var p in Model)
            {
                <tr>
                    <td>@p.PaymentID</td>
                    <td>@p.Type</td>
                    <td>@p.Amount.ToString("N0") VNĐ</td>
                    <td>@p.PaymentDate.ToString()</td>
                    <td class="text-center">
                        @if (p.Status == "Paid")
                        {
                            <span class="badge bg-success">Đã thanh toán</span>
                        }
                        else if (p.Status == "Pending")
                        {
                            <span class="badge bg-info text-dark">Chờ duyệt</span>
                        }
                        else if (p.Status == "Overdue")
                        {
                            <span class="badge bg-danger">Quá hạn</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Chưa thanh toán</span>
                        }
                    </td>
                    <td>
                        @if (p.Status == "Unpaid")
                        {
                            <button type="button" class="btn btn-success btn-sm" onclick="loadQR(@p.PaymentID)">Thanh toán</button>
                        }
                        else
                        {
                            <span class="text-muted">Đã thanh toán</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>


    <!-- Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body" id="qrModalContent">
                    <!-- Nội dung QR sẽ được load vào đây -->
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        function loadQR(paymentId) {
            $('#qrModalContent').html('<p class="text-center">Đang tải mã QR...</p>');
            var modal = new bootstrap.Modal(document.getElementById('qrModal'));
            modal.show();

            $.ajax({
                url: '/ThanhToan/QRPopup',
                type: 'GET',
                data: { id: paymentId },
                success: function (html) {
                    $('#qrModalContent').html(html);
                },
                error: function () {
                    $('#qrModalContent').html('<p class="text-danger text-center">Không thể tải mã QR.</p>');
                }
            });
        }
    </script>
}