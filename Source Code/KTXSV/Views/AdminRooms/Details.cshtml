@model KTXSV.Models.Room
@{
    ViewBag.Title = "Chi tiết phòng";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h2 class="mb-4 text-primary">Phòng @Model.RoomNumber - Tòa @Model.Building</h2>

<h4>Thông tin phòng</h4>
<table class="table table-bordered">
    <tr><th>Tòa</th><td>@Model.Building</td></tr>
    <tr><th>Số phòng</th><td>@Model.RoomNumber</td></tr>
    <tr><th>Giới tính</th><td>@(Model.Gender=="Male" ? "Nam" : "Nữ")</td></tr>
    <tr><th>Sức chứa</th><td>@Model.Capacity</td></tr>
    <tr><th>Đang ở</th><td>@Model.Occupied</td></tr>
    <tr><th>Giá phòng</th><td>@String.Format("{0:N0} đ", Model.Price)</td></tr>
    <tr>
        <th>Trạng thái</th>
        <td>
            @if (Model.Status == "Available")
            {
                <span class="badge bg-success">Còn trống</span>
            }
            else if (Model.Status.Equals("Full", StringComparison.OrdinalIgnoreCase))
            {
                <span class="badge bg-danger">Đầy</span>
            }
            else
            {
                <span class="badge bg-warning text-dark">Bảo trì</span>
            }
        </td>
    </tr>
</table>

<h4 class="mt-4">Danh sách sinh viên đang ở</h4>
<table class="table table-bordered table-sm">
    <thead class="table-primary">
        <tr>
            <th>Họ tên</th>
            <th>SĐT</th>
            <th>Giường</th>
            <th>Ngày bắt đầu</th>
            <th>Ngày kết thúc</th>
            <th>Trạng thái</th>
            <th>Chức năng</th>
        </tr>
    </thead>
    <tbody>
        @if (ViewBag.CurrentStudents != null && ViewBag.CurrentStudents.Count > 0)
        {
            foreach (var s in ViewBag.CurrentStudents)
            {
                string statusText = "Đang ở";
                string badgeClass = "success";

                switch (s.Status)
                {
                    case "Active": statusText = "Đang ở"; badgeClass = "success"; break;
                    case "Approved": statusText = "Đã duyệt"; badgeClass = "info"; break;
                    case "Pending": statusText = "Chờ duyệt"; badgeClass = "primary"; break;
                    case "Ended": statusText = "Đã kết thúc"; badgeClass = "dark"; break;
                    case "Transferred": statusText = "Đã chuyển"; badgeClass = "warning"; break;
                    case "Canceled": statusText = "Đã hủy"; badgeClass = "secondary"; break;
                }

                <tr>
                    <td>@s.User.FullName</td>
                    <td>@s.User.Phone</td>
                    <td>@s.Bed.BedNumber</td>
                    <td>@s.StartDate.ToString("dd/MM/yyyy")</td>
                    <td>@s.EndDate.ToString("dd/MM/yyyy")</td>
                    <td><span class="badge bg-@badgeClass">@statusText</span></td>
                    <td>
                        <a href="@Url.Action("TransferRoom", "AdminRooms", new { id = s.RegID })"
                           class="btn btn-sm btn-outline-primary">Chuyển phòng</a>

                        @if (s.Bed.IsOccupied && s.Bed.Booking != true)
                        {
                            using (Html.BeginForm("ReleaseBed", "AdminRooms", FormMethod.Post, new { @style = "display:inline" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="bedID" value="@s.Bed.BedID" />
                                <button type="submit" class="btn btn-sm btn-success ml-1"
                                        onclick="return confirm('Bạn có chắc chắn muốn mở giường này cho đăng ký?');">
                                    Cho phép đăng ký
                                </button>
                            }
                        }
                        else if (s.Bed.Booking == true)
                        {
                            <span class="badge bg-warning ml-1">Đã mở cho đăng ký</span>
                        }
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="7" class="text-center text-muted">Không có sinh viên nào ở phòng này</td>
            </tr>
        }
    </tbody>
</table>

<h4 class="mt-4">Lịch sử đăng ký phòng</h4>
<table class="table table-bordered table-sm">
    <thead class="table-light">
        <tr>
            <th>Họ tên</th>
            <th>Giường</th>
            <th>Ngày bắt đầu</th>
            <th>Ngày kết thúc</th>
            <th>Trạng thái</th>
            <th>Ghi chú</th>
        </tr>
    </thead>
    <tbody>
        @if (ViewBag.History != null && ViewBag.History.Count > 0)
        {
            foreach (var h in ViewBag.History)
            {
                string badgeClass = "secondary";
                string statusText = h.Status;

                switch (h.Status)
                {
                    case "Active": statusText = "Đang ở"; badgeClass = "success"; break;
                    case "Ended": statusText = "Đã kết thúc"; badgeClass = "dark"; break;
                    case "Transferred": statusText = "Đã chuyển"; badgeClass = "warning"; break;
                    case "Canceled": statusText = "Đã hủy"; badgeClass = "secondary"; break;
                }

                <tr>
                    <td>@h.User.FullName</td>
                    <td>@(h.Bed != null ? h.Bed.BedNumber : "-")</td>
                    <td>@h.StartDate.ToString("dd/MM/yyyy")</td>
                    <td>@h.EndDate.ToString("dd/MM/yyyy")</td>
                    <td><span class="badge bg-@badgeClass">@statusText</span></td>
                    <td>@h.Note</td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="6" class="text-center text-muted">Chưa có lịch sử đăng ký</td></tr>
        }
    </tbody>
</table>

<a href="@Url.Action("Index", "AdminRooms")" class="btn btn-secondary mt-3">Quay lại</a>
